(library
 (name binaryen_native)
 (public_name binaryen.native)
 (implements binaryen)
 (foreign_stubs
  (language c)
  (names binaryen_stubs_types binaryen_stubs_ops binaryen_stubs_literals
    binaryen_stubs_expressions binaryen_stubs_functions
    binaryen_stubs_imports binaryen_stubs_exports binaryen_stubs_globals
    binaryen_stubs_function_tables binaryen_stubs_memory
    binaryen_stubs_features binaryen_stubs_modules ocaml_helpers)
  (flags
   (:include c_flags.sexp)))
 (foreign_archives binaryen)
 (c_library_flags
  (:include c_library_flags.sexp)))

(rule
 (targets c_flags.sexp c_library_flags.sexp)
 (action
  (run ../config/discover.exe)))

(rule
 (target binaryen-c.h)
 (action
  (copy ../vendor/%{system}/include/binaryen-c.h binaryen-c.h)))

(rule
 (target libbinaryen.a)
 (enabled_if
  (<> %{system} mingw64))
 (action
  (copy ../vendor/%{system}/lib/libbinaryen.a libbinaryen.a)))

(rule
 (target libbinaryen.a)
 (enabled_if
  (= %{system} mingw64))
 (action
  (copy ../vendor/%{system}/lib/libbinaryen.dll.a libbinaryen.a)))

(rule
 (target dllbinaryen.so)
 (enabled_if
  (= %{system} macosx))
 (action
  (copy ../vendor/%{system}/lib/libbinaryen.dylib dllbinaryen.so)))

(rule
 (target dllbinaryen.so)
 (enabled_if
  (= %{system} linux))
 (action
  (copy ../vendor/%{system}/lib/libbinaryen.so dllbinaryen.so)))

(rule
 (target dllbinaryen.dll)
 (enabled_if
  (= %{system} mingw64))
 (action
  (copy ../vendor/%{system}/lib/libbinaryen.dll dllbinaryen.dll)))
